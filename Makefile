SHELL = /bin/bash


TOPDIR := $(shell git rev-parse --show-toplevel)
BRANCH := $(git rev-parse --abbrev-ref HEAD)
GOCODE := $(TOPDIR)/gocode
BUILD_ARTIFACTS := $(TOPDIR)/build_artifacts
LAMBDAS := $(GOCODE)/lambdas
TEST_RESULTS := $(TOPDIR)/test-results

default: build

test:
	@echo Testing
	@mkdir -p $(TEST_RESULTS)
	@go get -u github.com/jstemmer/go-junit-report
	@go test  -v 2>&1 ./... | go-junit-report > ${TEST_RESULTS}/report.xml
	@cat ${TEST_RESULTS}/report.xml

build:
	@echo Start Building Process
	@mkdir -p ${BUILD_ARTIFACTS}
	@for d in $(shell ls ${LAMBDAS}) ; do \
		cd $(LAMBDAS)/$$d; \
		DNAME="`pwd | rev | cut -d '/' -f 1 | rev`";\
		go build  -o ${BUILD_ARTIFACTS}/"$$DNAME"; \
		zip ${BUILD_ARTIFACTS}/"$$DNAME".zip ${BUILD_ARTIFACTS}/"$$DNAME"; \
		rm ${BUILD_ARTIFACTS}/"$$DNAME"; \
		cd ..; \
	done


clean:
	@echo Removing
	@rm -rf ${BUILD_ARTIFACTS}
	@rm -rf ${TEST_RESULTS}
