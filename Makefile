SHELL = /bin/bash


TOPDIR := $(shell git rev-parse --show-toplevel)
BRANCH := $(git rev-parse --abbrev-ref HEAD)
GOCODE := $(TOPDIR)/gocode
BUILD_ARTIFACTS := $(TOPDIR)/build_artifacts
LAMBDAS := $(GOCODE)/lambdas
TEST_RESULTS := $(TOPDIR)/test-results
PACKAGE_NAMES := $(go list ./...)

default: build

test:
	@echo Testing
	@mkdir -p $(TEST_RESULTS)
	@go get -u gotest.tools/gotestsum
	@gotestsum --format=short-verbose --junitfile ${TEST_RESULTS}/gotestsum-report.xml -- ${PACKAGE_NAMES}
	@go test  -v ./...

build:
	@echo Start Building Process
	@mkdir -p ${BUILD_ARTIFACTS}
	@for d in $(shell ls ${LAMBDAS}) ; do \
		cd $(LAMBDAS)/$$d; \
		DNAME="`pwd | rev | cut -d '/' -f 1 | rev`";\
		go build  -o ${BUILD_ARTIFACTS}/"$$DNAME"; \
		zip ${BUILD_ARTIFACTS}/"$$DNAME".zip ${BUILD_ARTIFACTS}/"$$DNAME"; \
		rm ${BUILD_ARTIFACTS}/"$$DNAME"; \
		cd ..; \
	done


clean:
	@echo Removing
	@rm -rf ${BUILD_ARTIFACTS}
	@rm -rf ${TEST_RESULTS}
