
provider "aws" {
  region = var.region
}

terraform {
  backend "s3" {
    bucket = "persepolis-terraform-backend"
    region = "us-east-1"
  }
}

module "s3_metadata_lambda" {
  source = "git::https://github.com/salvormallow/persepolis_modules.git//lambda_cloudwatch_trigger"

  event_trigger_name = aws_cloudwatch_event_rule.every_five_minutes.name
  event_trigger_arn = aws_cloudwatch_event_rule.every_five_minutes.arn
  lambda_environmental_variables = {
    VULN_URL_TABLE = "cve_urls"
  }
  lambda_filename = "nvd_downloader.zip"
  lambda_function_name = "${var.prefix}-nvd_downoader"
  lambda_handler = "main"
  lambda_policy_name = "nvd_downloader_policy"
  lambda_policy_template = "./policies/nvd_downloader_lambda.json"
  lambda_policy_variables = {
    s3_metadata_table = aws_dynamodb_table.vulnerability_collector_table.arn
  }
  prefix = var.prefix
}

resource "aws_cloudwatch_event_rule" "every_five_minutes" {
  name = "${var.prefix}-every_five_minutes"
  description = "Triggers nvd_downloader every 5 mins"
  schedule_expression = "rate(5 minutes)"
}


data "aws_region" "current" {}